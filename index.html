
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Welcome to ODRI Motor Board Configuration’s documentation! &#8212; ODRI Motor Board Configuration 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Motor Paramter Identification" href="motor_id.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="welcome-to-odri-motor-board-configuration-s-documentation">
<h1>Welcome to ODRI Motor Board Configuration’s documentation!<a class="headerlink" href="#welcome-to-odri-motor-board-configuration-s-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>The <a class="reference external" href="https://github.com/open-dynamic-robot-initiative/user_config_f28069m_drv8305">user_config_f28069m_drv8305</a> repository contains the firmware configuration
files for the ODRI project.  They are based on the config files included in the
<a class="reference external" href="https://www.ti.com/tool/MOTORWARE">MotorWare</a> examples and can be used for those.  Likewise they are used by our
<a class="reference external" href="https://open-dynamic-robot-initiative.github.io/mw_dual_motor_torque_ctrl/index.html" title="(in ODRI Firmware for CAN v1.0.0)"><span class="xref std std-doc">firmware</span></a> (both CAN and SPI versions).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The structure of these config files is not ideal.  Configuration is
duplicated for the single-motor and dual-motor applications and also some
global, motor-indepented values (like CPU frequency) are duplicated in the
config files for the second motor but those duplicates are not used
anywhere.</p>
<p>This is because the files are based on the configuration files of the
MotorWare example projects and probably were not meant to be used like this
in production.  However, we keep this structure to preserve compatibility
with those example projects.</p>
</div>
<section id="about-the-different-files">
<h2>About the Different Files<a class="headerlink" href="#about-the-different-files" title="Permalink to this headline">¶</a></h2>
<p>There are different files for single motor and dual motor projects. For each
case there are again separate files for the motors connected to J1 and J5. Lots
of the content of these files is the same so there is quite some copy&amp;past
mess.</p>
<section id="single-motor-applications">
<h3>Single Motor Applications<a class="headerlink" href="#single-motor-applications" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Filename</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>user.h</p></td>
<td><p>Main configuration file. Configures the microcontroller and which of
the motors is used (J1 or J5).</p></td>
</tr>
<tr class="row-odd"><td><p>user_j1.h</p></td>
<td><p>Configuration specific for the motor and inverter board on J1.</p></td>
</tr>
<tr class="row-even"><td><p>user_j5.h</p></td>
<td><p>Configuration specific for the motor and inverter board on J5.</p></td>
</tr>
</tbody>
</table>
<p>Note that user_j1.h and user_j5.h have exactly the same structure.</p>
</section>
<section id="dual-motor-applications">
<h3>Dual Motor Applications<a class="headerlink" href="#dual-motor-applications" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Filename</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>user1.h</p></td>
<td><p>Corresponds to user.h for single motor applications and includes config for J1</p></td>
</tr>
<tr class="row-odd"><td><p>user2.h</p></td>
<td><p>Same as user1.h but includes config for J5.<sup>1</sup></p></td>
</tr>
<tr class="row-even"><td><p>user_mtr_on_j1.h</p></td>
<td><p>Same as user_j1.h.</p></td>
</tr>
<tr class="row-odd"><td><p>user_mtr_on_j5.h</p></td>
<td><p>Same as user_j5.h but all defines are suffixed with “_2”.</p></td>
</tr>
</tbody>
</table>
<p><sup>1</sup> Note that <code class="docutils literal notranslate"><span class="pre">user2.h</span></code> also duplicates all the global settings of
<code class="docutils literal notranslate"><span class="pre">user1.h</span></code> (e.g. CPU frequency), which does not really make sense.  Those
settings are most likely not used anywhere, as the ones from <code class="docutils literal notranslate"><span class="pre">user1.h</span></code> are
used.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that configuration for J1 is duplicated between user_j1.h and
user_mtr_on_j1.h, so make sure to apply relevant changes to both files. The
same holds for user_j5.h and user_on_mtr_j5.h (where the latter has suffix
“_2” in all defines).</p>
</div>
</section>
</section>
<section id="select-motor-in-single-motor-application">
<h2>Select Motor in Single-Motor-Application<a class="headerlink" href="#select-motor-in-single-motor-application" title="Permalink to this headline">¶</a></h2>
<p>When running a single motor application (i.e. one that uses <code class="docutils literal notranslate"><span class="pre">user.h</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">user1.h,</span> <span class="pre">user2.h</span></code>, it has to be defined in the configuration file which
of the two slots (J1 or J5) shall be used. This is done in <code class="docutils literal notranslate"><span class="pre">user.h</span></code>. At the
top of the file there is a line</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define J1  </span><span class="c1">// or J5</span>
</pre></div>
</div>
<p>Set this to J1 or J5 to use the corresponding motor.</p>
</section>
<section id="configure-system-frequencies">
<h2>Configure System Frequencies<a class="headerlink" href="#configure-system-frequencies" title="Permalink to this headline">¶</a></h2>
<p>As explained in
<a class="reference external" href="https://open-dynamic-robot-initiative.github.io/mw_dual_motor_torque_ctrl/program_structure_and_frequencies.html" title="(in ODRI Firmware for CAN v1.0.0)"><span>Program Structure &amp; Frequencies</span></a>, different
parts of the program run at different frequencies. This is accomplished by
defining a base frequency and a set of “decimation factors”. This is done in
the <code class="docutils literal notranslate"><span class="pre">*_j1/5.h</span></code> configuration files, so different frequencies can be set for
the two motors.</p>
<p>The base frequency is the PWM, which is defined by <code class="docutils literal notranslate"><span class="pre">USER_PWM_FREQ_kHz</span></code> in the
section “CLOCKS &amp; TIMERS”. For a single motor, this can be set to something
like 45. For dual motor applications set it to a lower value as there has to be
enough CPU time left for the second motor. It may also be good to set slightly
different values for the two motors so that the controllers are not always
triggered at the same time (the example projects use 20 and 18, which seems to
work well).</p>
<p>The decimation factors are defined in the section “DECIMATION” as follows:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define USER_NUM_X_TICKS_PER_Y_TICK n</span>
</pre></div>
</div>
<p>This means that every n-th time X is executed, Y will be run. If X runs with
frequency <span class="math notranslate nohighlight">\(f_X\)</span> the resulting frequency for Y will be</p>
<div class="math notranslate nohighlight">
\[f_Y = \frac{f_X}{\text{USER_NUM_X_TICKS_PER_Y_TICK}}\]</div>
<div class="admonition-example admonition">
<p class="admonition-title">Example</p>
<p>If <code class="docutils literal notranslate"><span class="pre">USER_PWM_FREQ_kHz</span> <span class="pre">=</span> <span class="pre">20</span></code>, <code class="docutils literal notranslate"><span class="pre">USER_PWM_TICKS_PER_ISR_TICK</span> <span class="pre">=</span> <span class="pre">2</span></code>, and
<code class="docutils literal notranslate"><span class="pre">USER_ISR_TICKS_PER_SPEED_TICK</span> <span class="pre">=</span> <span class="pre">10</span></code>, the ISR is executed every second
PWM cycle and every 10-th time the ISR is run, it will run the speed
controller. This means <code class="docutils literal notranslate"><span class="pre">f_ISR</span> <span class="pre">=</span> <span class="pre">10kHz</span></code> and <code class="docutils literal notranslate"><span class="pre">f_controller</span> <span class="pre">=</span> <span class="pre">1kHz</span></code>.</p>
</div>
<p>Below is a complete list of all decimation factors that are defined:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>USER_NUM_ISR_TICKS_PER_CTRL_TICK</p></td>
<td><p>Defines the frequency of the control loop.</p>
<p>⚠️  This is not implemented correctly. <strong>Always set it to 1!</strong></p>
</td>
</tr>
<tr class="row-odd"><td><p>USER_NUM_CTRL_TICKS_PER_CURRENT_TICK</p></td>
<td><p>Defines the frequency of the low-level current controller.</p>
<p>ℹ️  This is actually the not used! The current controller runs at
ISR frequency.</p>
</td>
</tr>
<tr class="row-even"><td><p>USER_NUM_CTRL_TICKS_PER_EST_TICK</p></td>
<td><p>Defines the frequency of the FAST estimator.</p>
<p>ℹ️  This is not used in our code, as we do not use FAST.</p>
</td>
</tr>
<tr class="row-odd"><td><p><strong>USER_NUM_CTRL_TICKS_PER_POSCONV_TICK</strong></p></td>
<td><p>Defines the frequency of the SpinTAC PositionConverter module
(responsible for providing motor position and speed).</p>
<p>⚠️  Must be at least three times the frequency of highest expected
electrical velocity, otherwise velocity will suffer from an overflow!</p>
</td>
</tr>
<tr class="row-even"><td><p><strong>USER_NUM_CTRL_TICKS_PER_SPEED_TICK</strong></p></td>
<td><p>Defines the frequency of the high level controller (which, depending on
the firmware that is used, does not necessarily have to be a speed
controller).</p></td>
</tr>
<tr class="row-odd"><td><p>USER_NUM_CTRL_TICKS_PER_TRAJ_TICK</p></td>
<td><p>This is not used by our code.</p></td>
</tr>
</tbody>
</table>
<p>For the dual_motor_torque_ctrl project (which is the one that is used on the
board when it is controlled via CAN), only the bold factors should be modified.</p>
</section>
<section id="configure-motor-parameters">
<h2>Configure Motor Parameters<a class="headerlink" href="#configure-motor-parameters" title="Permalink to this headline">¶</a></h2>
<p>Adding new motors to the configuration is handled in <a class="reference internal" href="motor_id.html"><span class="doc">Motor Paramter Identification</span></a>.</p>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<p>Checkout the Texas Instruments’ InstaSPIN-FOC/-MOTION User’s Guide for more
information on the various parameters and their effects.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="#">ODRI Motor Board Configuration</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="motor_id.html">Motor Paramter Identification</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
      <li>Next: <a href="motor_id.html" title="next chapter">Motor Paramter Identification</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Max Planck Society.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>